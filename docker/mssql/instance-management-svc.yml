# SPDX-License-Identifier: Apache-2.0
# Licensed to the Ed-Fi Alliance under one or more agreements.
# The Ed-Fi Alliance licenses this file to you under the Apache License, Version 2.0.
# See the LICENSE and NOTICES files in the project root for more information.

services:
  instance-management-service:
    build:
      context: ../../
      dockerfile: docker/Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      EdFi:AdminConsole:AppSettings__DatabaseEngine: ${DatabaseEngine:-SqlServer}
      EdFi:AdminConsole:AppSettings__PathBase: ${PathBase:-""}
      EdFi:AdminConsole:AppSettings__DefaultPageSizeOffset: 0
      EdFi:AdminConsole:AppSettings__DefaultPageSizeLimit: 25
      EdFi:AdminConsole:AppSettings__OverrideExistingDatabase: ${OverrideExistingDatabase:-false}
      EdFi:AdminConsole:AppSettings__IgnoresCertificateErrors: ${IgnoresCertificateErrors:-true}
      EdFi:AdminConsole:AppSettings__SqlServerBacFile: ${SqlServerBacFile:-"./Ods_Minimal_Template.bak"}
      EdFi:AdminConsole:ConnectionStrings__EdFi_Master: ${EdFi_Master:-"Data Source=host.docker.internal;Initial Catalog=master;User ID=sa;Password=1StrongPwd!!;Trusted_Connection=false;Encrypt=True;TrustServerCertificate=True;Persist Security Info=True;"}
      EdFi:AdminConsole:ConnectionStrings__EdFi_Ods: ${EdFi_Ods:-"Data Source=host.docker.internal;Initial Catalog={0};User ID=sa;Password=1StrongPwd!!;Trusted_Connection=false;Encrypt=True;TrustServerCertificate=True;Persist Security Info=True;"}
      EdFi:AdminConsole:AdminApiSettings__AccessTokenUrl: ${AccessTokenUrl:-"https://host.docker.internal/auth/realms/edfi-admin-console/protocol/openid-connect/token"}
      EdFi:AdminConsole:AdminApiSettings__AdminConsoleTenantsURL: ${AdminConsoleTenantsURL:-"https://host.docker.internal/adminapi/adminconsole/tenants"}
      EdFi:AdminConsole:AdminApiSettings__AdminConsoleInstancesURL: ${AdminConsoleInstancesURL:-"https://host.docker.internal/adminapi/adminconsole/instances?status={0}"}
      EdFi:AdminConsole:AdminApiSettings__AdminConsoleCompleteInstancesURL: ${AdminConsoleCompleteInstancesURL:-"https://host.docker.internal/adminapi/adminconsole/instances/{0}/completed"}
      EdFi:AdminConsole:AdminApiSettings__Username: ${Username:-"adminconsole-user"}
      EdFi:AdminConsole:AdminApiSettings__ClientId: ${ClientId:-"admin-console"}
      EdFi:AdminConsole:AdminApiSettings__Password: ${Password:-"SomePassword"}
      EdFi:AdminConsole:DatabaseProvider: ${DatabaseProvider:-"System.Data.SqlClient"}
    volumes:
      - service-logs:/var/log/acinstancesvc
  
  sqlserver:
    build:
      context: .
      dockerfile: Dockerfile
    # image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=1StrongPwd!!
      - MSSQL_PID=Developer
    user: root
    ports:
      - 1433:1433
    volumes:
      - sqlserver_data:/var/opt/mssql
    restart: always
    
volumes:
  sqlserver_data:
    name: sqlserver_data
  service-logs:
    name: instance-management-service-logs
